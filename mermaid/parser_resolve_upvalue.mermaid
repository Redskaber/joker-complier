flowchart TD
    A[开始] --> B{是否有外围作用域?}
    B -->|否| C[返回 -1]
    B -->|是| D{当前函数是否为脚本?}
    D -->|是| C[返回 -1]
    D -->|否| E[查找局部变量]
    E --> F{找到局部变量?}
    F -->|是| G[标记为被捕获]
    G --> H[创建 upvalue 信息]
    H --> I[返回 upvalue 索引]
    F -->|否| J[递归查找上层 upvalue]
    J --> K{找到 upvalue?}
    K -->|是| L[创建 upvalue 信息]
    L --> M[返回 upvalue 索引]
    K -->|否| N[返回 -1]
